/*
 * LCD_GUI.c
 *
 *  Created on: Nov 18, 2019
 *      Author: cal
 */


#include"LCD_GUI.h"

unsigned char CharTable[][17]={

///**/	{' ', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,},

		{' ',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'!',	0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x18,0x18,0x00,0x00,	},
		{'"',	0x00,0x48,0x6C,0x24,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'#',	0x00,0x00,0x00,0x24,0x24,0x24,0x7F,0x12,0x12,0x12,0x7F,0x12,0x12,0x12,0x00,0x00,	},
		{'$',	0x00,0x00,0x08,0x1C,0x2A,0x2A,0x0A,0x0C,0x18,0x28,0x28,0x2A,0x2A,0x1C,0x08,0x08,	},
		{'%',	0x00,0x00,0x00,0x22,0x25,0x15,0x15,0x15,0x2A,0x58,0x54,0x54,0x54,0x22,0x00,0x00,	},
		{'&',	0x00,0x00,0x00,0x0C,0x12,0x12,0x12,0x0A,0x76,0x25,0x29,0x11,0x91,0x6E,0x00,0x00,	},
		{'\'',	0x00,0x06,0x06,0x04,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'(',	0x00,0x40,0x20,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x10,0x20,0x40,0x00,	},
		{')',	0x00,0x02,0x04,0x08,0x08,0x10,0x10,0x10,0x10,0x10,0x10,0x08,0x08,0x04,0x02,0x00,	},
		{'*',	0x00,0x00,0x00,0x00,0x08,0x08,0x6B,0x1C,0x1C,0x6B,0x08,0x08,0x00,0x00,0x00,0x00,	},
		{'+',	0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x7F,0x08,0x08,0x08,0x08,0x00,0x00,0x00,	},
		{',',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x04,0x03,	},
		{'-',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'.',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x00,0x00,	},
		{'/',	0x00,0x00,0x80,0x40,0x40,0x20,0x20,0x10,0x10,0x08,0x08,0x04,0x04,0x02,0x02,0x00,	},
		{'0',	0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00,	},
		{'1',	0x00,0x00,0x00,0x08,0x0E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,	},
		{'2',	0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x20,0x20,0x10,0x08,0x04,0x42,0x7E,0x00,0x00,	},
		{'3',	0x00,0x00,0x00,0x3C,0x42,0x42,0x20,0x18,0x20,0x40,0x40,0x42,0x22,0x1C,0x00,0x00,	},
		{'4',	0x00,0x00,0x00,0x20,0x30,0x28,0x24,0x24,0x22,0x22,0x7E,0x20,0x20,0x78,0x00,0x00,	},
		{'5',	0x00,0x00,0x00,0x7E,0x02,0x02,0x02,0x1A,0x26,0x40,0x40,0x42,0x22,0x1C,0x00,0x00,	},
		{'6',	0x00,0x00,0x00,0x38,0x24,0x02,0x02,0x1A,0x26,0x42,0x42,0x42,0x24,0x18,0x00,0x00,	},
		{'7',	0x00,0x00,0x00,0x7E,0x22,0x22,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,	},
		{'8',	0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x24,0x18,0x24,0x42,0x42,0x42,0x3C,0x00,0x00,	},
		{'9',	0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,0x64,0x58,0x40,0x40,0x24,0x1C,0x00,0x00,	},
		{':',	0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,	},
		{';',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x04,	},
		{'<',	0x00,0x00,0x00,0x40,0x20,0x10,0x08,0x04,0x02,0x04,0x08,0x10,0x20,0x40,0x00,0x00,	},
		{'=',	0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,	},
		{'>',	0x00,0x00,0x00,0x02,0x04,0x08,0x10,0x20,0x40,0x20,0x10,0x08,0x04,0x02,0x00,0x00,	},
		{'?',	0x00,0x00,0x00,0x3C,0x42,0x42,0x46,0x40,0x20,0x10,0x10,0x00,0x18,0x18,0x00,0x00,	},
		{'@',	0x00,0x00,0x00,0x1C,0x22,0x5A,0x55,0x55,0x55,0x55,0x2D,0x42,0x22,0x1C,0x00,0x00,	},
		{'A',	0x00,0x00,0x00,0x08,0x08,0x18,0x14,0x14,0x24,0x3C,0x22,0x42,0x42,0xE7,0x00,0x00,	},
		{'B',	0x00,0x00,0x00,0x1F,0x22,0x22,0x22,0x1E,0x22,0x42,0x42,0x42,0x22,0x1F,0x00,0x00,	},
		{'C',	0x00,0x00,0x00,0x7C,0x42,0x42,0x01,0x01,0x01,0x01,0x01,0x42,0x22,0x1C,0x00,0x00,	},
		{'D',	0x00,0x00,0x00,0x1F,0x22,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1F,0x00,0x00,	},
		{'E',	0x00,0x00,0x00,0x3F,0x42,0x12,0x12,0x1E,0x12,0x12,0x02,0x42,0x42,0x3F,0x00,0x00,	},
		{'F',	0x00,0x00,0x00,0x3F,0x42,0x12,0x12,0x1E,0x12,0x12,0x02,0x02,0x02,0x07,0x00,0x00,	},
		{'G',	0x00,0x00,0x00,0x3C,0x22,0x22,0x01,0x01,0x01,0x71,0x21,0x22,0x22,0x1C,0x00,0x00,	},
		{'H',	0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,	},
		{'I',	0x00,0x00,0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,	},
		{'J',	0x00,0x00,0x00,0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x11,0x0F,	},
		{'K',	0x00,0x00,0x00,0x77,0x22,0x12,0x0A,0x0E,0x0A,0x12,0x12,0x22,0x22,0x77,0x00,0x00,	},
		{'L',	0x00,0x00,0x00,0x07,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x42,0x7F,0x00,0x00,	},
		{'M',	0x00,0x00,0x00,0x77,0x36,0x36,0x36,0x36,0x2A,0x2A,0x2A,0x2A,0x2A,0x6B,0x00,0x00,	},
		{'N',	0x00,0x00,0x00,0xE3,0x46,0x46,0x4A,0x4A,0x52,0x52,0x52,0x62,0x62,0x47,0x00,0x00,	},
		{'O',	0x00,0x00,0x00,0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x22,0x1C,0x00,0x00,	},
		{'P',	0x00,0x00,0x00,0x3F,0x42,0x42,0x42,0x42,0x3E,0x02,0x02,0x02,0x02,0x07,0x00,0x00,	},
		{'Q',	0x00,0x00,0x00,0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x4D,0x53,0x32,0x1C,0x60,0x00,	},
		{'R',	0x00,0x00,0x00,0x3F,0x42,0x42,0x42,0x3E,0x12,0x12,0x22,0x22,0x42,0xC7,0x00,0x00,	},
		{'S',	0x00,0x00,0x00,0x7C,0x42,0x42,0x02,0x04,0x18,0x20,0x40,0x42,0x42,0x3E,0x00,0x00,	},
		{'T',	0x00,0x00,0x00,0x7F,0x49,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x1C,0x00,0x00,	},
		{'U',	0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,	},
		{'V',	0x00,0x00,0x00,0xE7,0x42,0x42,0x22,0x24,0x24,0x14,0x14,0x18,0x08,0x08,0x00,0x00,	},
		{'W',	0x00,0x00,0x00,0x6B,0x49,0x49,0x49,0x49,0x55,0x55,0x36,0x22,0x22,0x22,0x00,0x00,	},
		{'X',	0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x18,0x18,0x18,0x24,0x24,0x42,0xE7,0x00,0x00,	},
		{'Y',	0x00,0x00,0x00,0x77,0x22,0x22,0x14,0x14,0x08,0x08,0x08,0x08,0x08,0x1C,0x00,0x00,	},
		{'Z',	0x00,0x00,0x00,0x7E,0x21,0x20,0x10,0x10,0x08,0x04,0x04,0x42,0x42,0x3F,0x00,0x00,	},
		{'[',	0x00,0x78,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x78,0x00,	},
		{'\\',	0x00,0x00,0x02,0x02,0x04,0x04,0x08,0x08,0x08,0x10,0x10,0x20,0x20,0x20,0x40,0x40,	},
		{']',	0x00,0x1E,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x1E,0x00,	},
		{'^',	0x00,0x38,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'_',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,	},
		{'`',	0x00,0x06,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{'a',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x78,0x44,0x42,0x42,0xFC,0x00,0x00,	},
		{'b',	0x00,0x00,0x00,0x03,0x02,0x02,0x02,0x1A,0x26,0x42,0x42,0x42,0x26,0x1A,0x00,0x00,	},
		{'c',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x44,0x02,0x02,0x02,0x44,0x38,0x00,0x00,	},
		{'d',	0x00,0x00,0x00,0x60,0x40,0x40,0x40,0x78,0x44,0x42,0x42,0x42,0x64,0xD8,0x00,0x00,	},
		{'e',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x7E,0x02,0x02,0x42,0x3C,0x00,0x00,	},
		{'f',	0x00,0x00,0x00,0xF0,0x88,0x08,0x08,0x7E,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,	},
		{'g',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x22,0x22,0x1C,0x02,0x3C,0x42,0x42,0x3C,	},
		{'h',	0x00,0x00,0x00,0x03,0x02,0x02,0x02,0x3A,0x46,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,	},
		{'i',	0x00,0x00,0x00,0x0C,0x0C,0x00,0x00,0x0E,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,	},
		{'j',	0x00,0x00,0x00,0x30,0x30,0x00,0x00,0x38,0x20,0x20,0x20,0x20,0x20,0x20,0x22,0x1E,	},
		{'k',	0x00,0x00,0x00,0x03,0x02,0x02,0x02,0x72,0x12,0x0A,0x16,0x12,0x22,0x77,0x00,0x00,	},
		{'l',	0x00,0x00,0x00,0x0E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,	},
		{'m',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x92,0x92,0x92,0x92,0x92,0xB7,0x00,0x00,	},
		{'n',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3B,0x46,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,	},
		{'o',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x42,0x42,0x3C,0x00,0x00,	},
		{'p',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1B,0x26,0x42,0x42,0x42,0x22,0x1E,0x02,0x07,	},
		{'q',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x78,0x44,0x42,0x42,0x42,0x44,0x78,0x40,0xE0,	},
		{'r',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x77,0x4C,0x04,0x04,0x04,0x04,0x1F,0x00,0x00,	},
		{'s',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x42,0x02,0x3C,0x40,0x42,0x3E,0x00,0x00,	},
		{'t',	0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x3E,0x08,0x08,0x08,0x08,0x08,0x30,0x00,0x00,	},
		{'u',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x63,0x42,0x42,0x42,0x42,0x62,0xDC,0x00,0x00,	},
		{'v',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x14,0x08,0x08,0x00,0x00,	},
		{'w',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xEB,0x49,0x49,0x55,0x55,0x22,0x22,0x00,0x00,	},
		{'x',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x76,0x24,0x18,0x18,0x18,0x24,0x6E,0x00,0x00,	},
		{'y',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x24,0x24,0x14,0x18,0x08,0x08,0x07,	},
		{'z',	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x22,0x10,0x08,0x08,0x44,0x7E,0x00,0x00,	},
		{'{',	0x00,0xC0,0x20,0x20,0x20,0x20,0x20,0x10,0x20,0x20,0x20,0x20,0x20,0x20,0xC0,0x00,	},
		{'|',	0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,	},
		{'}',	0x00,0x06,0x08,0x08,0x08,0x08,0x08,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x06,0x00,	},
		{'~',	0x0C,0x32,0xC2,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,	},
		{0,},
};

const Word_Module WordTable[]={
		{"你", },
		{0,},
};

void drawPoint(uint16_t x, uint16_t y, uint16_t color){
	LCD_SetXY(x,y);
	LCD_WriteReg(0x2c, color);
}

void clearScreen(uint16_t color){
	LCD_SetXY(0,0);
	LCD_WR_REG(0x2c);
	for(int i=0;i<(240*320);i++){
		LCD_WR_DATA(color);
	}
}

uint16_t abs4lcd(int16_t a){
	if(a<0){
		return -a;
	}else{
		return a;
	}
}

void drawLine(uint16_t startX, uint16_t startY, uint16_t endX, uint16_t endY, uint16_t color){
//	LCD_SetXY(startX, startY);

	uint16_t start_x=startX;
	uint16_t start_y=startY;
	uint16_t end_x=endX;
	uint16_t end_y=endY;

	if(((int16_t)endX-(int16_t)startX)<0){
		start_x=endX;
		end_x=startX;
	}
	if(((int16_t)endY-(int16_t)startY)<0){
		start_y=endY;
		end_y=startY;
	}

	uint16_t x_dis=end_x-start_x;
	uint16_t y_dis=end_y-start_y;
	float slope=(float)y_dis/(float)x_dis;
	drawPoint(start_x, start_y, color);
	if(x_dis<y_dis){
		for(;y_dis;y_dis--){
			drawPoint(start_x+((float)y_dis/slope),start_y+y_dis, color);
		}
	}else{
		for(;x_dis;x_dis--){
			drawPoint(start_x+x_dis, start_y+((float)x_dis*slope), color);
		}
	}
}

void drawRect(uint16_t startX, uint16_t startY, uint16_t endX, uint16_t endY, uint16_t color){
	drawLine(startX, startY, endX, startY, color);//上边
	drawLine(startX, endY, endX, endY, color);//下边
	drawLine(startX, startY, startX, endY, color);//左边
	drawLine(endX, startY, endX, endY, color);//右边
}

void drawSquare(uint16_t startX, uint16_t startY, uint16_t endX, uint16_t endY, uint16_t color){
	for(uint16_t i=startY;i<=endY;i++){
		LCD_SetXY(startX, i);
		LCD_WR_REG(0x2c);
		for(uint16_t j=startX;j<=endX;j++){
			LCD_WR_DATA(color);
		}
	}
}

void drawRectWithBorder(uint16_t startX, uint16_t startY, uint16_t endX, uint16_t endY, uint16_t color, uint8_t border){
	uint16_t start_x=startX;
	uint16_t start_y=startY;
	uint16_t end_x=endX;
	uint16_t end_y=endY;

	if(((int16_t)endX-(int16_t)startX)<0){
		start_x=endX;
		end_x=startX;
	}
	if(((int16_t)endY-(int16_t)startY)<0){
		start_y=endY;
		end_y=startY;
	}

	for(;border;border--){
		drawRect(start_x+border-1, start_y+border-1, end_x-border+1, end_y-border+1, color);
	}
}

void draw16x8(uint16_t x, uint16_t y, uint8_t*buf, uint16_t font_color, uint16_t back_color){
	for(uint8_t i=0;i<16;i++){
		for(uint8_t j=0;j<8;j++){
			uint8_t mask=(0x01<<j);//找到的字库有猫病，和正常的是反的(左右呈镜像），正常应该是0x80>>j
			if(buf[i]&mask){
				drawPoint(x+j, y+i, font_color);
			}else{
				drawPoint(x+j, y+i, back_color);
			}
		}
	}
}

void draw16x16(uint16_t x, uint16_t y, uint16_t*buf, uint16_t font_color, uint16_t back_color){
	for(uint8_t i=0;i<16;i++){
		for(uint8_t j=0;j<16;j++){
			uint16_t mask=(0x8000>>j);
			if(buf[i]&mask){
				drawPoint(x+j, y+i, font_color);
			}else{
				drawPoint(x+j, y+i, back_color);
			}
		}
	}
}

//charTable 的第一个uint8_t 来表示编码， 后面的16个uint8_t来表示字模
void printChar(uint16_t x, uint16_t y,uint8_t charTable[][17], uint8_t whichChar, uint16_t font_color, uint16_t back_color){
	for(; charTable[0][0]; charTable++){
		if(charTable[0][0]==whichChar){
			draw16x8(x, y, ((uint8_t*)charTable)+1 , font_color, back_color);
			break;
		}
	}
}

//wordTable 的前1个uint32_t来表示编码， 后面16个uint16_t来表示字模, 使用的是UTF-8编码， 一个汉字一般占24bit， UTF-8是变长编码
void printWord(uint16_t x, uint16_t y, Word_Module *wordTable, uint32_t whichWord, uint16_t font_color, uint16_t back_color){
	for(; wordTable->Word; wordTable++){
		if(*(wordTable->Word)==*((uint32_t*)whichWord)){
			draw16x16(x, y, wordTable->Module, font_color, back_color);
			break;
		}
	}
}



//这个函数用SD卡中的UNICODE的字库来处理中文。 首先，linux下cubeIDE中的编码是UTF-8
uint8_t printMultiString(uint16_t x, uint16_t y, uint8_t *p, uint16_t font_color, uint16_t back_color){

	uint8_t size=0;
	uint8_t buf[32]={0};
	uint32_t res=0;
	uint8_t sta=0;
	FIL fil;

	sta = f_open(&fil, "1:/UNI_01.font16\0", FA_READ);
	for(int i=0;(sta!=FR_OK)&&(i<5);i++){
		SD_Init();
		sta = f_open(&fil, "1:/UNI_01.font16\0", FA_READ);
	}
	if(sta != FR_OK){
		return sta;
	}

	res = 0x55555555;

	for(int s=0;(res!=0xFFFFFFFF)&&(res!=0x00)&&(sta == FR_OK);s++){
		res = UTF8_2_UNICODE(p, &size);
		p+=size;

		if(res<0x80 && size<2){
			printChar(x, y, CharTable, res, font_color, back_color);
			x+=s*8;
		}else if(res&0x80 && res<65511){
			uint32_t index = (res-0xA4)*32;
			f_lseek(&fil, index);
			UINT read=0;
			sta = f_read(&fil, buf, 32, &read);
			if(read != 32){
				res = f_close(&fil);
				return res;
			}
			for(int i=0;i<16;i++){
				LCD_SetXY(x, y+i);
				LCD_WR_REG(0x2c);
				for(int j=0;j<8;j++){
					if(buf[i*2]&(0x80>>j)){
						LCD_WR_DATA(font_color);
					}else{
						LCD_WR_DATA(back_color);
					}
				}
				for(int j=0;j<8;j++){
					if(buf[i*2+1]&(0x80>>j)){
						LCD_WR_DATA(font_color);
					}else{
						LCD_WR_DATA(back_color);
					}
				}
			}
			x+=s*16;
		}else if(res<0xFFFFFFFF){
			x+=s*16;
		}else{
			f_close(&fil);
			return res;
		}
	}
	res = f_close(&fil);
	return res;
}

void printString(uint16_t x, uint16_t y, uint8_t charTable[][17], Word_Module *wordTable, uint8_t* str, uint16_t font_color, uint16_t back_color){
	uint8_t tmpx=0;
	uint8_t tmpy=0;
	for(uint16_t cur=0; str[cur]; ){
		if(str[cur]&0x80){
			//如果是汉字
			uint32_t whichWord=0;
			whichWord |= str[cur];
			whichWord |= str[cur+1]<<8;
			whichWord |= str[cur+2]<<16;
			printWord(x+8*cur, y, wordTable, whichWord, font_color, back_color);
			cur+=3;
			tmpx+=2;
		}else if(str[cur]!='\n'){
			//如果是char
			printChar(x+8*tmpx, y+16*tmpy, charTable, str[cur], font_color, back_color);
			cur+=1;
			tmpx+=1;
		}else if(str[cur]=='\n'){
			cur+=1;
			tmpy+=1;
			tmpx=0;
		}
	}
}

void printNum(uint16_t x, uint16_t y, int32_t Num, uint16_t font_color, uint16_t back_color){
	int32_t num=Num;
	uint8_t numbuf[12]={0};
	numbuf[11]=0;
	uint8_t cur=11;
	if(num<0){
		num=-num;
	}
	if(num==0){
		cur--;
		numbuf[cur]='0';
		printString(x, y, CharTable, WordTable, numbuf+cur, font_color, back_color);
		return;
	}
	for(;num;num/=10){
		cur--;
		numbuf[cur]=(num%10)+'0';
	}
	if(Num<0){
		cur--;
		numbuf[cur]='-';
	}
	printString(x, y, CharTable, WordTable, numbuf+cur, font_color, back_color);
	return;
}

void printNumWithClear(uint16_t x, uint16_t y, int32_t Num, uint8_t clearNum, uint16_t font_color, uint16_t back_color){
	int32_t num=Num;
	uint8_t numbuf[12]={0};
	if(clearNum>11){
		clearNum=11;
	}
	for(int i=0;i<clearNum;i++){
		numbuf[i]=' ';
		numbuf[i+1]=0;
	}
	printString(x, y, CharTable, WordTable, numbuf, font_color, back_color);
	numbuf[11]=0;
	uint8_t cur=11;
	if(num<0){
		num=-num;
	}
	if(num==0){
		cur--;
		numbuf[cur]='0';
		printString(x, y, CharTable, WordTable, numbuf+cur, font_color, back_color);
		return;
	}
	for(;num;num/=10){
		cur--;
		numbuf[cur]=(num%10)+'0';
	}
	if(Num<0){
		cur--;
		numbuf[cur]='-';
	}
	printString(x, y, CharTable, WordTable, numbuf+cur, font_color, back_color);
	return;
}



void drawButton(uint8_t *name, uint16_t start_x, uint16_t start_y, uint16_t end_x, uint16_t end_y, uint16_t font_color, uint16_t back_color, uint16_t border_color){
	drawRectWithBorder(start_x, start_y, end_x, end_y, border_color, 4);
	drawSquare(start_x+4, start_y+4, end_x-4, end_y-4, back_color);
	uint8_t i=0;
	for(i=0;name[i];i++);
	printString(start_x+4+(end_x-start_x-8)/2-i*4, start_y+4+(end_y-start_y-8)/2-8, CharTable, WordTable, name, font_color, back_color);
}

BUTTON_S buttons[20]={0};
uint8_t buttons_counter=0;
void ButtonCreate(uint8_t *name, uint8_t id, uint16_t start_x, uint16_t start_y, uint16_t end_x, uint16_t end_y, void(*handle)(uint8_t), uint16_t font_color, uint16_t back_color, uint16_t border_color){
	buttons[id].start_x=start_x;
	buttons[id].end_x=end_x;
	buttons[id].start_y=start_y;
	buttons[id].end_y=end_y;
	buttons[id].font_color=font_color;
	buttons[id].back_color=back_color;
	buttons[id].border_color=border_color;
	buttons[id].id=id;
	buttons[id].handler=handle;
	for(int i=0;name[i]&&(i<12);i++){
		buttons[id].name[i]=name[i];
	}
	buttons[id].name[11]=0;
	drawButton(name, start_x, start_y, end_x, end_y, font_color, back_color, border_color);

	buttons_counter++;
}


uint16_t gui_touch_x, gui_touch_y;

void ScreenScan(){
	uint8_t status;
	status=get_Pen_XY(&gui_touch_x, &gui_touch_y);
	if(status){
		ButtonsScan(1);
	}else{
		ButtonsScan(0);
	}
}

void ButtonsScan(uint8_t isPressed){
	if(isPressed){
		for(int i=0;i<buttons_counter;i++){
			if(((gui_touch_x>buttons[i].start_x)&&(gui_touch_x<buttons[i].end_x))&&((gui_touch_y>buttons[i].start_y)&&(gui_touch_y<buttons[i].end_y))){
				if(buttons[i].isPressed<10){
					buttons[i].isPressed++;
				}
				if(buttons[i].isPressed>5){
					buttons[i].isRelated=0;
				}
				if(buttons[i].isPressed==6){
					buttons[i].onePressedFlag=1;
				}
			}else{
				if(buttons[i].isRelated<10){
					buttons[i].isRelated++;
				}
				if(buttons[i].isRelated>5){
					buttons[i].isPressed=0;
				}
			}
		}
	}else{
		for(int i=0;i<buttons_counter;i++){
			buttons[i].isPressed=0;
		}
	}
}

void Button_dothings(){
	for(int i=0;i<buttons_counter;i++){
		if(buttons[i].onePressedFlag){
			buttons[i].onePressedFlag=0;
			buttons[i].handler(buttons[i].id);
		}
	}
}

